#!/usr/bin/perl -ls
#	Погода 2.0-beta-0 - погодный скрипт, основанный на Pogoda.Yandex API
#	Известные баги: XML::XPath тормозит программу.
#	To-Do: 	парсинг английских городов;
#			переключение языков;
#			цветное отображение температуры;
#			отображение таблицы по ширине терминала.

use strict;
use warnings;
use LWP::Simple qw($ua get);
use XML::XPath;
use utf8;
use Encode;

#	Декларируем массивы для обработки

my @a; #	Массив для температур, влажностей, etc.
my @b; #	Массив для состояний погоды (гроза, ливень, etc.)

binmode(STDOUT,':utf8');
my $city = shift;
if (not defined $city) {die "Использование: $0 <город>\n";}
$city = decode ('utf8', $city);
$city = uc(substr $city, 0,1) . lc(substr $city, 1);
$ua->agent('Webkit Gecko/1.0');
my $url = "https://pogoda.yandex.ru/static/cities.xml";
my $xml = get $url || die 'Unable to get cities list';
my $xp = XML::XPath->new(xml => $xml);
my $id = $xp->find("/cities/country/city[text()='$city']/\@id");
$url = "http://export.yandex.ru/weather-ng/forecasts/$id.xml";
$xml = get $url || die "404 - xml";
$xp = XML::XPath->new(xml => $xml);

#	Обработка направления ветра - заменяет направление ветра на указатель

sub arrow($) {
	my $dir = shift;
	my %a = ("n" => "(↑)","s"=>"(↓)","w"=>"(←)","e"=>"(→)","nw"=>"(↖)","ne"=>"(↗)","sw"=>"(↙)","se"=>"(↘)");
	return $a{$dir};
}

#	Парсинг - в декларированные массивы заносятся данные из XML файла

sub parse() {
	for (my $i=2;$i<=10;$i++) {
		for (my $j=1;$j<=4;$j++) {
			$a[$i-2][$j-1] = $xp->find("//day[$i]/day_part[$j]/temperature-data/avg/text()") . "°C, " . $xp->find("//day[$i]/day_part[$j]/wind_speed/text()") . "мс" . arrow($xp->find("//day[$i]/day_part[$j]/wind_direction/text()")) . ', ' . $xp->find("//day[$i]/day_part[$j]/humidity/text()") . '%';
			$b[$i-2][$j-1] = $xp->find("//day[$i]/day_part[$j]/weather_type/text()");
		}
	}
}

#	Вывод - используется система format для удобной работы с псевдографикой

sub output() {
	parse;
	my $place = $xp->find('/*/@city') . ', ' . $xp->find('/*/@country');
	my $today = $xp->find('//fact/temperature/text()') . '°C, ' . $xp->find('//fact/weather_type/text()') . '; ' . $xp->find('//fact/humidity/text()') . '%; ' . $xp->find('//fact/wind_speed/text()') . "мс" . arrow($xp->find('//fact/wind_direction/text()')) . ', ' . $xp->find('//fact/pressure/text()') . ' мм рт.ст.' . ' ' . "Восход: " . $xp->find('//day[1]/sunrise/text()') . ', ' . "закат: " . $xp->find('//day[1]/sunset/text()');
	format STDOUT =
╔═══════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║					  @||||||||||||||||||||||||||||||                                   ║
					  $place
╠═════╦═════════════════════════════════════════════════════════════════════════════════════════════════════╣
║Сег. ║	@|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||| ║
		$today
╠═════╬═════════════════════════════════╦═════════════════════════════════╦═════════════════════════════════╣
║Дата ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$xp->find("//day[2]/\@date"),	  $xp->find("//day[3]/\@date"), 	$xp->find("//day[4]/\@date")
║Утро ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][0],						  $a[1][0],							$a[2][0]
║06:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][0],						  $b[1][0],							$b[2][0]
║День ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][1],						  $a[1][1],							$a[2][1]
║12:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][1],						  $b[1][1],							$b[2][1]
║Вечер║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][2],						  $a[1][2],							$a[2][2]
║18:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][2],						  $b[1][2],							$b[2][2]
║Ночь ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][3],						  $a[1][3],							$a[2][3]
║24:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][3],						  $b[1][3],							$b[2][3]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣
║Дата ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$xp->find("//day[5]/\@date"),	  $xp->find("//day[6]/\@date"), 	$xp->find("//day[7]/\@date")
║Утро ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][0],						  $a[4][0],							$a[5][0]
║06:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[3][0],						  $b[4][0],							$b[5][0]
║День ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][1],						  $a[4][1],							$a[5][1]
║12:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[3][1],						  $b[4][1],							$b[5][1]
║Вечер║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][2],						  $a[4][2],							$a[5][2]
║18:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[3][2],						  $b[4][2],							$b[5][2]
║Ночь ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][3],						  $a[4][3],							$a[5][3]
║24:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][3],						  $b[1][3],							$b[2][3]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣
║Дата ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$xp->find("//day[8]/\@date"),	  $xp->find("//day[9]/\@date"), 	$xp->find("//day[10]/\@date")
║Утро ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][0],						  $a[7][0],							$a[8][0]
║06:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][0],						  $b[7][0],							$b[8][0]
║День ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][1],						  $a[7][1],							$a[8][1]
║12:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][1],						  $b[7][1],							$b[8][1]
║Вечер║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][2],						  $a[7][2],							$a[8][2]
║18:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][2],						  $b[7][2],							$b[8][2]
║Ночь ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][3],						  $a[7][3],							$a[8][3]
║24:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][3],						  $b[7][3],							$b[8][3]
╚═════╩═════════════════════════════════╩═════════════════════════════════╩═════════════════════════════════╝
.
	write;
	return 0;
}

exit output();	#	выполняем программу
