#!/usr/bin/perl -ls
#	Погода 2.0 alpha - погодный скрипт, основанный на Pogoda.Yandex API
#	Известные баги: спасибо XML::XPath за ручной тормоз в работе прграммы, однако он удобен в программировании. Город необходимо вводить с большой буквы (готовится исправление). 
#	To-Do: 	Добавить парсинг английских городов и переключение языков, отображения температуры и давления, цветное отображение температуры.
use strict;
use LWP::Simple;
use XML::XPath;
use utf8;
use Encode;

#	Декларируем массивы для обработки

my @a; #	Массив для температур, влажностей, etc.
my @b; #	Массив для состояний погоды (гроза, ливень, etc.)

binmode(STDOUT,':utf8');

my $city = shift;
if (not defined $city) {die "Использование: $0 <город>\n";}
$city = decode ('utf8', $city);
my $cities = get('https://pogoda.yandex.ru/static/cities.xml') or die "404 - Невозможно получить список городов!\n";
my $xp = XML::XPath->new(xml => $cities);
my $id = $xp->find("/cities/country/city[text()='$city']/\@id");
$city = get("http://export.yandex.ru/weather-ng/forecasts/$id.xml");
$xp = XML::XPath->new(xml => $city);
exit output();	#	выполняем программу

#	Обработка направления ветра - заменяет направление ветра на указатель

sub arrow($) {
	my $dir = shift;
	my %a = ("n" => "↑","s"=>"↓","w"=>"←","e"=>"→","nw"=>"↖","ne"=>"↗","sw"=>"↙","se"=>"↘");
	return $a{$dir};
}

#	Парсинг - в декларированные массивы заносятся данные из XML файла

sub parse() {
	for (my $i=2;$i<=10;$i++) {
		for (my $j=1;$j<=4;$j++) {
			$a[$i-2][$j-1] = $xp->find("//day[$i]/day_part[$j]/temperature-data/avg/text()") . "°C, " . $xp->find("//day[$i]/day_part[$j]/wind_speed/text()") . "мс(" . arrow($xp->find("//day[$i]/day_part[$j]/wind_direction/text()")) . '), ' . $xp->find("//day[$i]/day_part[$j]/humidity/text()") . '%';
			$b[$i-2][$j-1] = $xp->find("//day[$i]/day_part[$j]/weather_type_short/text()");
		}
	}
}

#	Вывод - используется система format для удобной работы с псевдографикой

sub output() {
	parse;
	my $place = $xp->find('/*/@city') . ', ' . $xp->find('/*/@country');
	my $today = $xp->find('//fact/temperature/text()') . '°C, ' . $xp->find('//fact/weather_type/text()') . '; ' . $xp->find('//fact/humidity/text()') . '%; ' . $xp->find('//fact/wind_speed/text()') . "мс(" . arrow($xp->find('//fact/wind_direction/text()')) . ')' . ', ' . $xp->find('//fact/pressure/text()') . ' мм рт.ст.' . ' ' . "Восход: " . $xp->find('//day[1]/sunrise/text()') . ', ' . "закат: " . $xp->find('//day[1]/sunset/text()');
	format STDOUT =	
╔═══════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                         @||||||||||||||||||||||||||||||                                   ║
										  $place	
╠═════╦═════════════════════════════════════════════════════════════════════════════════════════════════════╣		
║Сег. ║	@|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||| ║
		$today
╠═════╩═════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                             ПРОГНОЗ ПОГОДЫ НА 9 ДНЕЙ                                      ║
╠═════╦═════════════════════════════════╦═════════════════════════════════╦═════════════════════════════════╣							
║Дата ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$xp->find("//day[2]/\@date"),	  $xp->find("//day[3]/\@date"), 	$xp->find("//day[4]/\@date") 
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Утро ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][0],						  $a[1][0],							$a[2][0]
║06:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][0],						  $b[1][0],							$b[2][0]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║День ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][1],						  $a[1][1],							$a[2][1]
║12:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][1],						  $b[1][1],							$b[2][1]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Вечер║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][2],						  $a[1][2],							$a[2][2]
║18:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][2],						  $b[1][2],							$b[2][2]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Ночь ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[0][3],						  $a[1][3],							$a[2][3]
║24:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][3],						  $b[1][3],							$b[2][3]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣								
║Дата ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$xp->find("//day[5]/\@date"),	  $xp->find("//day[6]/\@date"), 	$xp->find("//day[7]/\@date") 
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Утро ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][0],						  $a[4][0],							$a[5][0]
║06:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[3][0],						  $b[4][0],							$b[5][0]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║День ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][1],						  $a[4][1],							$a[5][1]
║12:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[3][1],						  $b[4][1],							$b[5][1]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Вечер║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][2],						  $a[4][2],							$a[5][2]
║18:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[3][2],						  $b[4][2],							$b[5][2]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Ночь ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[3][3],						  $a[4][3],							$a[5][3]
║24:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[0][3],						  $b[1][3],							$b[2][3]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣								
║Дата ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$xp->find("//day[8]/\@date"),	  $xp->find("//day[9]/\@date"), 	$xp->find("//day[10]/\@date") 
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Утро ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][0],						  $a[7][0],							$a[8][0]
║06:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][0],						  $b[7][0],							$b[8][0]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║День ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][1],						  $a[7][1],							$a[8][1]
║12:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][1],						  $b[7][1],							$b[8][1]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Вечер║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][2],						  $a[7][2],							$a[8][2]
║18:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][2],						  $b[7][2],							$b[8][2]
╠═════╬═════════════════════════════════╬═════════════════════════════════╬═════════════════════════════════╣		
║Ночь ║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$a[6][3],						  $a[7][3],							$a[8][3]
║24:00║	@|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║ @|||||||||||||||||||||||||||||| ║
		$b[6][3],						  $b[7][3],							$b[8][3]
╚═════╩═════════════════════════════════╩═════════════════════════════════╩═════════════════════════════════╝
.
	write;
	return 0;
}
